parameters:
  - name: environment
    type: string

stages:
  - stage: deploy_${{ lower(parameters.environment) }}

    variables:
    - template: ../variables/${{ lower(parameters.environment) }}.yml
    - group: ${{ upper(parameters.environment) }}

    jobs:
      - job: publish_app
        displayName: 'publish app'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "16.x"
            displayName: "Install Node.js"
          
          - task: Cache@2
            displayName: 'Cache node_modules'
            inputs:
              key: node_modules | $(Agent.OS) | package.json | yarn.lock
              path: '$(System.DefaultWorkingDirectory)/node_modules'

          - task: Cache@2
            displayName: 'Cache .next/cache'
            inputs:
              key: next | $(Agent.OS) | package.json | yarn.lock
              path: '$(System.DefaultWorkingDirectory)/.next/cache'
              
          - script: npm install
            displayName: "npm ci/install"
            workingDirectory: $(directory)
          
          - script: npm run type-check
            displayName: 'Check types'
            workingDirectory: $(directory)
          
          - script: npm run build
            displayName: "npm build"
            workingDirectory: $(directory)

          - script: npm run export
            displayName: "npm export"
            workingDirectory: $(directory)

          - task: AzureCLI@1
            displayName: "get deployment token"
            inputs:
              azureSubscription: ${{ variables.serviceConnection }}
              scriptLocation: inlineScript
              inlineScript: |
                deployment_token=$(az staticwebapp secrets list --name $(STATIC_APP_NAME) --resource-group $(RESOURCE_GROUP_INFRASTRUCTURE) --query properties.apiKey -o tsv)
                echo "##vso[task.setvariable variable=deployment_token;isSecret=true]$deployment_token"

          - task: AzureStaticWebApp@0
            inputs:
              app_location: "$(directory)/out"
            env:
              azure_static_web_apps_api_token: $(deployment_token)
